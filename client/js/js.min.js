/* 2015-07-04 */ var app=angular.module("rboard",["ui.router","ngAnimate"]);app.config(function(a,b){b.otherwise("/"),a.state("register",{url:"/page/register",controller:"registerController",templateUrl:"/client/html/register.html",title:"회원가입"}).state("board",{url:"/:url",controller:"boardController",templateUrl:"/client/html/board.html"}).state("write",{url:"/:url/write",controller:"writeController",templateUrl:"/client/html/write.html",title:"글쓰기"})}),app.config(["$locationProvider",function(a){a.html5Mode({enabled:!0,requireBase:!1})}]),app.factory("$io",function(){var a=io("http://localhost");return a}),app.factory("$req",function(a){var b={},c={};return a.on("$req",function(a){c[a.url](a.data)}),b=function(b,d,e){var f={};f.url=b,f.data=d,a.emit("$req",f),c[b]=e}}),app.service("$user",function(){}),app.controller("boardController",function(a,b,c,d){a.keyword="",a.$watch("keyword",function(){return void 0==a.keyword||""==a.keyword?void(a.results=[]):void b("post.search",a.keyword,function(b){function c(){for(var c=0;c<b.length;c++)if(b[c].board==a.keyword)return!0;return!1}if(!c()){var d={};d.count=0,d.board=a.keyword,b.push(d)}a.results=b,a.select=b[0],a.$apply()})}),a.$on("$stateChangeSuccess",function(){var b=a.req={};b.board=d.url,b.limit=3,b.skip=0,b.page=0,a.noMore=!1,a.getPosts()}),a.getPosts=function(){var c=a.req;c.skip=c.limit*c.page,b("post.get",c,function(b){void 0==a.titles&&(a.titles=[]),0==b.length&&(a.noMore=!0),b.forEach(function(b){a.titles.push(b)}),c.page++,a.$apply()})},a.selectResult=function(b){a.select=b},a.move=function(){c.go("board",{url:a.select.board})},a.keyPress=function(b){if(0!=a.results.length){var c=a.results.indexOf(a.select);switch(b.keyCode){case 38:c--,0>c&&(c=a.results.length-1),a.select=a.results[c];break;case 40:c++,c>a.results.length-1&&(c=0),a.select=a.results[c];break;case 13:a.move()}}},a.rand=function(){function a(a){var b=0;a.forEach(function(a){a.board!=d.url&&(b+=a.count)});for(var c=Math.random(),e=0,f=0;f<a.length;f++)if(a[f].board!=d.url&&(e+=a[f].count/b,e>c))return a[f].board}b("post.search","",function(b){console.log(a(b)),c.go("board",{url:a(b)})})}}),app.controller("registerController",function(a,b,c){a.user=c,a.register=function(){b("user.register",a.user,function(a){console.log(a)})},a.login=function(){b("user.login",a.user,function(a){return a.err?void alert(a.err):void(c.logged=!0)})}}),app.controller("root",function(a,b,c,d){b.$watch(function(){return c.current},function(){b.state=c.current,b.stateParams=d}),b.states=c.get()}),app.controller("writeController",function(a,b,c){a.article={},a.write=function(){a.article.board=c.url,b("post.write",a.article,function(a){return a.err?void alert(a.err):void alert("done")})}}),app.factory("$regex",function(){var a=function(b){if(void 0==a.regex[b])return!1;for(var c=a.regex[b],d=0;d<c.length;d++)if(!c[d]())return!1;return!0};return a.regex={},a.register=function(b,c){void 0==a.regex[b]&&(a.regex[b]=[]),a.regex[b].push(c)},a}),app.directive("regex",function(a,b){return{restrict:"A",scope:{},link:function(c,d,e){var f=angular.element("<div class='message' ng-show='!matched'>"+e.message+"</div>");a(f)(c),d[0].parentNode.insertBefore(f[0],d[0].nextSibling);var g=new RegExp(e.regex),h=c.$parent,i=function(){return g.test(h.$eval(e.ngModel))};b.register(e.check,i),h.$watch(e.ngModel,function(){return void 0==h.$eval(e.ngModel)||""==h.$eval(e.ngModel)||i()?(d.removeClass("waring"),void(c.matched=!0)):(d.addClass("waring"),void(c.matched=!1))})}}}),app.directive("textarea",function(){return{restrict:"E",link:function(a,b,c){var d=b[0].offsetHeight,e=b.css("paddingLeft"),f=b.css("paddingRight"),g=angular.element("<div></div>").css({position:"absolute",top:0,opacity:0,width:b[0].offsetWidth-parseInt(e||0)-parseInt(f||0),lineHeight:"15px",resize:"none"});angular.element(document.body).append(g);var h=function(){var a=function(a,b){for(var c=0,d="";b>c;c++)d+=a;return d},c=b.val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/\n$/,"<br/>&nbsp;").replace(/\n/g,"<br/>").replace(/\s{2,}/g,function(b){return a("&nbsp;",b.length-1)+" "});g.html(c),b.css("height",Math.max(g[0].offsetHeight,d)+"px")};b.bind("keyup keydown keypress change",h),h()}}});